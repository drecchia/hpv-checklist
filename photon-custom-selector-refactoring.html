<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HpvCheckList Component</title>
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0/dist/fuse.basic.min.js" integrity="sha256-1C+i/jM9DOPZNpliy6HamyBeT7NAbYD8iRmcZ2bopmY=" crossorigin="anonymous"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0 auto;
        }
        /*  THIS IS TEST ONLY  */
        .hpv-checklist {
            width: 400px;
            border-style: solid;
            border-width: thin;
            border-radius: 8px;
        }
        .hpv-checklist ul {
            list-style-type: none;
            padding: 0;
            margin: 0;
        }
        .hpv-checklist li {
            color: #303438;
            padding: 5px 10px;
            font-size: 12px;
            text-align: left;
            line-height: 18px;
            font-weight: 400;
            cursor: pointer;
        }
        .hpv-checklist li:hover {
            background-color: #f3f3f3;
        }
        .hpv-checklist label {
            display: inline-flex;
            align-items: center;
            cursor: pointer;
        }
        .hpv-checklist .hpv-checklist-content {
            overflow-y: auto;
            padding-top: 10px;
        }
        .hpv-checklist #root-container {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            flex-grow: 1;
            margin: 50px;
        }
        .hpv-checklist .search-container {
            position: relative;
            width: 100%;
        }
        .hpv-checklist .search-input {
            width: 100%;
            padding: 8px 30px 8px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .hpv-checklist .clear-search {
            position: absolute;
            right: 10px;
            top: 25%;
            height: 18px;
            background-color: #e3e3e3;
            border: 0;
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            width: 18px;
        }
        .hpv-checklist .clear-search:hover {
            background-color: #ffacac;
        }
        .hpv-checklist .optgroup {
            font-weight: bold;
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: #e7e7e7;
            padding: 5px 10px;
            color: rgba(48, 52, 56, .7);
            cursor: default;
            margin: 9px 0 0 0;
            font-size: 14px;
            text-shadow: none;
            line-height: 20px;
        }
        .hpv-checklist .optgroup::before {
            content: 'â–¼';
            display: inline-block;
            margin-right: 5px;
            transition: transform 0.3s;
        }
        .hpv-checklist .optgroup.collapsed::before {
            transform: rotate(-90deg);
        }
        .hpv-checklist .optgroup + ul {
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            max-height: 1000px;
            opacity: 1;
            overflow: hidden;
        }
        .hpv-checklist .optgroup.collapsed + ul {
            max-height: 0;
            opacity: 0;
        }
        .hpv-checklist .select-all-group {
            background: none;
            border: none;
            cursor: pointer;
            color: #2196F3;
            font-size: 12px;
            visibility: hidden;
        }
        .hpv-checklist .hpv-checklist-btn-group button {
            background: none;
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 14px;
            width: 100%;
        }
        .hpv-checklist .hpv-checklist-btn-group button:disabled {
            cursor: default;
            border-width: thin;
        }
        .hpv-checklist .hpv-checklist-btn-group button:not([disabled]) {
            border: 1px solid #2196F3;
            color: #2196F3;
        }
        .hpv-checklist .hpv-checklist-btn-group .select-all-main:not([disabled]):hover {
            background-color: #2196F3;
            color: white;
        }
        .hpv-checklist .hpv-checklist-status-container {
            display: flex;
            padding: 10px;
            justify-content: center;
            color: #a7a7a7;
        }
        .hpv-checklist .excluded-item {
            text-decoration: line-through;
            font-weight: bold;
            color: red;
        }
        .hpv-checklist .hpv-checklist-disabled {
            color: #ccc;
        }
        .hpv-checklist-btn-group .exclusion-mode-toggle.exclusion-active:not([disabled]) {
            color:red;
            border: 1px solid red;
        }
        .hpv-checklist-btn-group .exclusion-mode-toggle:not(.exclusion-active):not([disabled]) {
            color: #31d131;
            border: 1px solid #31d131;
        }
        .hpv-checklist-btn-group {
            display: flex;
            justify-content: flex-start;
            gap: 20px;
            padding-left: 10px;
            padding-right: 10px;
        }
    </style>
</head>
<body>
   <div id="checklist1"></div>

   <div style="display: flex;flex-direction: column;padding-top:50px;">
    <span>TODO:</span>
    <span>Max Nr of items</span>
    <span>Enable/disable exclusion mode</span>
    <span>Add/remove items after init</span>
    <span>Remove from list after click</span>
    <span>Not mandatory optgroups</span>
    <span>virtualscroll</span>
    <span>remote list</span>
    <span>focus search-input</span>
    <span>custom render list item</span>
    <span>List from js model</span>
   </div>

   <script>
class HpvCheckListError extends Error {
  constructor(message) {
    super(message);
    this.name = 'HpvCheckListError';
  }
};

class HpvCheckList {
    constructor(containerId, options = {}) {
        this.defaultOptions = {
            searchPlaceholder: "Search options...",
            selectAllMainText: "Select All Visible",
            selectAllGroupText: "Select All",
            clearSearchTooltip: "Clear Search",
            inclusionText: "Include in query",
            exclusionText: "Exclude from query",
            emptyText: "No items available",
            fuseThreshold: 0.3,
            selectMode: 'multiple',
            defaultMode: 'inclusion',
            maxSelectableItemsInclusionMode: 1000,
            maxSelectableItemsExclusionMode: 1000,
            onSelect: null,
            onDeselect: null,
            onSelectAll: null,
            onDeselectAll: null,
            onSelectGroup: null,
            onDeselectGroup: null,
            onCollapseGroup: null,
            onExpandGroup: null,
            onSearch: null,
            onClearSearch: null,
            onExclusionModeChange: null,
            items: [],
            disabledClass: 'hpv-checklist-disabled',
            fieldMap: {
                keyField: 'id',
                labelField: 'label',
                optgroupField: 'optgroup',
                disabledField: 'disabled',
                checkedInclusionField: 'checked',
                checkedExclusionField: null,
            },
        };

        this.MODE_EXCLUSION = 'exclusion';
        this.MODE_INCLUSION = 'inclusion';

        this.options = { ...this.defaultOptions, ...options };
        this.container = document.getElementById(containerId);
        this.containerId = containerId;

        // define working mode
        this.setCurrentMode( this.options.defaultMode );

        // Initialize sub-modules
        this.ui = new UIModule(this);
        this.search = new SearchModule(this);
        this.items = new ItemsModule(this);
    }

    addItems(userItems) {
        if (!userItems || Array.isArray(userItems) === false) {
            throw new HpvCheckListError('Invalid items format');
        }

        this.items.addMultiple(userItems);
        // TODO, move to ui
        this.afterAddOrRemoveItems();
    }

    addItem(item, fireAfterChange = true) {
        if (!item || typeof item !== 'object') {
            throw new HpvCheckListError('Invalid item format');
        }

        this.items.add(item);

        if ( fireAfterChange ) {
            // TODO, move to ui
            this.afterAddOrRemoveItems();
        }
    }

    setCurrentMode( mode ) {
        if ( mode == this.MODE_EXCLUSION ) {
            this.currentModeIsExclusion = true;
            this.currentModeIsInclusion = false;
        } else {
            this.currentModeIsExclusion = false;
            this.currentModeIsInclusion = true;
        }	
    }

    toogleCurrentMode() {
        this.setCurrentMode( this.currentModeIsExclusion ? this.MODE_INCLUSION : this.MODE_EXCLUSION );
    }

    afterAddOrRemoveItems() {
        if ( this.items.getSize() == 0 ) {
            this.ui.showCustomStatus(this.options.emptyText);
        } else {
            this.ui.hideStatus();
        }

        // only when items are added after init
        this.renderItems();
        this.setupItemsEventListeners();
        this.updateItemStates();
    }

    removeAllItems() {
        // we wont clear items, only delete el, keeping previous selected items on list
        this.items.clear();
        this.renderItems();
        this.setupItemsEventListeners();
        this.updateItemStates();

        this.afterAddOrRemoveItems();
    }
    
    checkItem(id, mode, check = true) {
        const item = this.items.items.get(id);
        // Do not allow to change disabled items
        if ( item.nativeDisabled ) return;

        if (item) {
            if (mode === this.MODE_INCLUSION) {
                item.checkedInclusion = check;
                item.checkedExclusion = false;
            } else if (mode === this.MODE_EXCLUSION) {
                item.checkedExclusion = check;
                item.checkedInclusion = false;
            }
            this.items.items.set(id, item);
            // render items
            this.updateItemStates();
        } else {
            console.warn(`Item with id "${id}" not found`);
        }
    }

    setItemVisibility(id, visible) {
        const item = this.items.items.get(id);
        if (item) {
            item.visible = visible;
            this.items.items.set(id, item);

            // style
            item.el.style.display = visible ? '' : 'none';
        }
    }

    renderItems() {
        const fragment = document.createDocumentFragment();
        const checkboxList = this.container.querySelector('.hpv-checklist-checkbox-list');
        checkboxList.innerHTML = '';

        const groupedItems = this.groupItems();

        for (const [groupName, items] of Object.entries(groupedItems)) {
            const optgroup = document.createElement('div');
            optgroup.className = 'optgroup';
            optgroup.innerHTML = `
                <span>${groupName}</span>
                <button class="select-all-group">${this.options.selectAllGroupText}</button>
            `;

            // set attribute group-name
            optgroup.setAttribute('group-name', groupName);

            fragment.appendChild(optgroup);

            const ul = document.createElement('ul');
            items.forEach((item) => {
                const li = document.createElement('li');
                li.className = item.disabled ? this.options.disabledClass : '';
                li.innerHTML = `
                    <input type="checkbox" id="${item.key}" name="${item.key}" ${item.disabled ? 'disabled' : ''} ${item.checkedInclusion ? 'checked' : ''}>
                    <label for="${item.key}">${item.label}</label>
                `;
                ul.appendChild(li);

                item.el = li;
            });
            fragment.appendChild(ul);
        }

        checkboxList.appendChild(fragment);
    }

    // refresh list state
    updateItemStates() {
        this.items.items.forEach((item, id) => {
            const itemContainer = item.el;
            // first input of itemContainer
            const checkbox = itemContainer.querySelector('input[type="checkbox"]');
            const label = checkbox.nextElementSibling;
            const isNativeDisabled = item.nativeDisabled;

            checkbox.checked = this.currentModeIsExclusion ? item.checkedExclusion : item.checkedInclusion;

            if ( isNativeDisabled ) {
                checkbox.disabled = true;
            } else {
                checkbox.disabled = this.currentModeIsExclusion ? item.checkedInclusion : item.checkedExclusion;
            }

            label.classList.toggle('excluded-item', this.currentModeIsExclusion && item.checkedExclusion);
            checkbox.closest('li').classList.toggle(this.options.disabledClass, checkbox.disabled);

            // change item title explaining why its disabled
            if (checkbox.disabled) {
                if ( isNativeDisabled ) {
                    // TODO: parametrize this message(s)
                    label.title = 'This item is disabled';
                } else {
                    // TODO: parametrize this message(s)
                    label.title = this.currentModeIsExclusion ? 'Included in query' : 'Excluded from query';
                }
            } else {
                label.title = '';
            }

            // Update data attributes
            if ( isNativeDisabled ) {
                item.checkableInclusion = false;
                item.checkableExclusion = false;
            } else {
                item.checkableInclusion = !item.checkedExclusion;
                item.checkableExclusion = !item.checkedInclusion;
            }
        });

        // update button state, because it depends on the items state, if all selected will change button state to disabled
        this.updateSelectAllButtonStates();
    }

    updateSelectAllButtonStates() {
        const visibleItems = Array.from(this.items.items.values()).filter(item => item.visible);
        const allChecked = visibleItems.every(item => 
            this.currentModeIsExclusion ? item.checkedExclusion : item.checkedInclusion
        );
        
        // const selectAllMain = this.container.querySelector('.select-all-main');
        // selectAllMain.disabled = allChecked || visibleItems.length === 0;

        const optgroups = this.container.querySelectorAll('.optgroup');
        optgroups.forEach(group => {
            const selectAllGroup = group.querySelector('.select-all-group');
            const groupItems = this.getGroupItems(group).filter(item => item.visible);
            const allGroupChecked = groupItems.every(item => 
                this.currentModeIsExclusion ? item.checkedExclusion : item.checkedInclusion
            );
            
            //selectAllGroup.disabled = allGroupChecked || groupItems.length === 0;
            selectAllGroup.style.visibility = (this.options.selectMode !== 'single' && groupItems.length > 0) ? 'visible' : 'hidden';
        });
    }

    setupItemsEventListeners() {
        this.setupCollapsibleOptgroups();
        this.setupClickableListItems();
        this.setupCheckboxes();
    }

    groupItems() {
        const groups = {};
        this.items.items.forEach(item => {
            if (!groups[item.optgroup]) {
                groups[item.optgroup] = [];
            }
            groups[item.optgroup].push(item);
        });
        return groups;
    }

    itemMatchesFilter(item, lowerFilter) {
        return item.label.toLowerCase().includes(lowerFilter) || 
            item.optgroup.toLowerCase().includes(lowerFilter);
    }

    setupCollapsibleOptgroups() {
        const optgroups = this.container.querySelectorAll('.optgroup');
        for (let group of optgroups) {
            group.addEventListener('click', (e) => {
                if (e.target.tagName.toLowerCase() === 'button') return;
                const isCollapsing = !group.classList.contains('collapsed');
                group.classList.toggle('collapsed');
                const ul = group.nextElementSibling;
                if (ul.tagName.toLowerCase() === 'ul') {
                    ul.style.display = isCollapsing ? 'none' : '';
                }
                const selectAllBtn = group.querySelector('.select-all-group');
                selectAllBtn.style.visibility = isCollapsing ? 'hidden' : 'visible';

                if (isCollapsing && this.options.onCollapseGroup) {
                    this.options.onCollapseGroup(group);
                } else if (!isCollapsing && this.options.onExpandGroup) {
                    this.options.onExpandGroup(group);
                }
            });
        }
    }

    setupClickableListItems() {
        const listItems = this.container.querySelectorAll('li');
        listItems.forEach(item => {
            item.addEventListener('click', (e) => {
                if (e.target.tagName.toLowerCase() !== 'input') {
                    const checkbox = item.querySelector('input[type="checkbox"]');
                    if (!checkbox.disabled) {
                        this.toggleItemSelection(checkbox.id);
                        e.preventDefault();
                    }
                }
            });
        });
    }

    setupCheckboxes() {
        const checkboxes = this.container.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', () => {
                this.toggleItemSelection(checkbox.id);
            });
        });
    }

    toggleItemSelection(id) {
        const item = this.items.items.get(id);
        if (!item) return;

        if (this.currentModeIsExclusion) {
            item.checkedExclusion = !item.checkedExclusion;
        } else {
            item.checkedInclusion = !item.checkedInclusion;
        }

        if (this.options.selectMode === 'single') {
            this.items.items.forEach((otherItem, otherId) => {
                if (otherId !== id) {
                    if (this.currentModeIsExclusion) {
                        otherItem.checkedExclusion = false;
                    } else {
                        otherItem.checkedInclusion = false;
                    }
                }
            });
        }

        this.updateItemStates();

        const isChecked = this.currentModeIsExclusion ? item.checkedExclusion : item.checkedInclusion;
        // set real checkbox state
        const elContainer = item.el;
        const checkbox = elContainer.querySelector('input[type="checkbox"]');
        // set attribute checked
        checkbox.setAttribute('checked', isChecked);
        console.log(checkbox);

        if (isChecked && this.options.onSelect) {
            this.options.onSelect(id, this.items.getSelectedItems());
        } else if (!isChecked && this.options.onDeselect) {
            this.options.onDeselect(id, this.items.getSelectedItems());
        }
    }

    getGroupItems(group) {
        // get attribute group-name
        const groupName = group.getAttribute('group-name');

        // find in this.items items where item.optgroup = groupName
        return Array.from(this.items.items.values()).filter(item => item.optgroup === groupName);
    }

    selectAllGroup(button) {
        if (this.options.selectMode === 'single') return;

        const group = button.closest('.optgroup');
        const groupItems = this.getGroupItems(group);
        const allChecked = groupItems.every((item) => {
            if ( item.nativeDisabled ) {
                return true;
            } else {
                return this.currentModeIsExclusion ? item.checkedExclusion : item.checkedInclusion;
            }
        });

        groupItems.forEach(item => {
            if ( this.currentModeIsInclusion ) {
                this.checkItem(item.key, this.MODE_INCLUSION, !allChecked);
            } else {
                this.checkItem(item.key, this.MODE_EXCLUSION, !allChecked);
            }
        });

        if (!allChecked && this.options.onSelectGroup) {
            this.options.onSelectGroup(group.textContent.trim(), groupItems.map(item => item.key), this.items.getSelectedItems());
        } else if (allChecked && this.options.onDeselectGroup) {
            this.options.onDeselectGroup(group.textContent.trim(), groupItems.map(item => item.key), this.items.getSelectedItems());
        }
    }

    selectAllMain() {
        if (this.options.selectMode === 'single') return;

        // get all ids and filter by visible items
        const visibleItems = Array.from(this.items.items.entries())
            .filter(([_, item]) => item.visible)
            .map(([id, item]) => ({id, ...item}));

        const allChecked = visibleItems.every((item) => {
            if ( item.nativeDisabled ) {
                return true;
            } else {
                return this.currentModeIsExclusion ? item.checkedExclusion : item.checkedInclusion;
            }
        });

        visibleItems.forEach(item => {
            // Do not allow to uncheck disabled items
            if ( item.nativeDisabled ) return;

            if (this.currentModeIsExclusion) {
                this.checkItem(item.key, this.MODE_EXCLUSION, !allChecked);
            } else {
                this.checkItem(item.key, this.MODE_INCLUSION, !allChecked);
            }
        });

        if (!allChecked && this.options.onSelectAll) {
            this.options.onSelectAll(visibleItems.map(item => item.key), this.items.getSelectedItems());
        } else if (allChecked && this.options.onDeselectAll) {
            this.options.onDeselectAll(visibleItems.map(item => item.key), this.items.getSelectedItems());
        }
    }
};

class ItemsModule {
    constructor(p) {
        if (!(p instanceof HpvCheckList)) {
            throw new HpvCheckListError('Parent must be an instance of HpvCheckList');
        }

        this.parent = p;
        this.items = new Map(); // Store all items { id, el, internal } with their states
    }

    // to item module
    getSelectedItems() {
        // list all entries from this.items where (item.checkedExclusion || item.checkedInclusion)
        return Array.from(this.items.entries())
            .filter(([_, item]) => this.parent.currentModeIsExclusion ? item.checkedExclusion : item.checkedInclusion)
            .map(([_, item]) => item);
    }

    // to item module
    getSelectedIds() {
        return Array.from(this.items.entries())
            .filter(([_, item]) => this.parent.currentModeIsExclusion ? item.checkedExclusion : item.checkedInclusion)
            .map(([id, _]) => id);
    }

    addMultiple(userItems) {
        userItems.forEach(item => this.add(item, false));
    }

    add(item, fireAfterChange = true) {
        const { keyField, labelField, optgroupField, disabledField, checkedInclusionField, checkedExclusionField } = this.parent.options.fieldMap;

        const key = item[keyField] + ''; // protection
        const label = item[labelField];
        const optgroup = item[optgroupField];
        const disabled = item[disabledField] || false;
        const checkedInclusion = item[checkedInclusionField] || false;
        const checkedExclusion = item[checkedExclusionField] || false;

        this.items.set(key, {
            key: key,
            label: label,
            optgroup: optgroup,
            disabled: disabled,
            checkedInclusion: checkedInclusion,
            checkedExclusion: checkedExclusion,
            // internal
            checkableInclusion: true,
            checkableExclusion: true,
            nativeDisabled: disabled,
            visible: true,
        });

        if ( fireAfterChange ) {
            this.parent.afterAddOrRemoveItems();
        }
    }

    remove(id) {
        if (this.items.has(id)) {
            this.items.delete(id);
            return true;
        }

        return false;
    }

    removeAll() {
        // NOTE: will we really remove all items or delete el from DOM?
        this.items.clear();
    }

    getSize() {
        return this.items.size;
    }
};

class SearchModule {
    constructor(p) {
        if (!(p instanceof HpvCheckList)) {
            throw new HpvCheckListError('Parent must be an instance of HpvCheckList');
        }

        this.parent = p;
        this.setupSearchInput();
        this.setupClearSearchButton();
        this.setupSearchInputShortcut();
    }

    setupSearchInput() {
        const searchInput = this.parent.container.querySelector('.search-input');
        searchInput.addEventListener('input', () => this.performSearch(searchInput.value));
    }

    setupClearSearchButton() {
        const clearButton = this.parent.container.querySelector('.clear-search');
        clearButton.addEventListener('click', () => this.clearSearch());
    }

    setupSearchInputShortcut() {
        const searchInput = this.parent.container.querySelector('.search-input');
        searchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && e.shiftKey) {
                e.preventDefault();
                this.parent.selectAllMain();
                // clear input
                this.clearSearch();
            }
        });
    }

    clearSearch() {
        const searchInput = this.parent.container.querySelector('.search-input');
        searchInput.value = '';
        searchInput.dispatchEvent(new Event('input'));
        if (this.parent.options.onClearSearch) {
            this.parent.options.onClearSearch(this.parent.items.getSelectedItems());
        }
    }

    performSearch(filter) {
        const lowerFilter = filter.toLowerCase();
        const optgroups = this.parent.container.querySelectorAll('.optgroup');
        let visibleItemsCount = 0;

        this.parent.items.items.forEach((item, id) => {
            const visible = this.parent.itemMatchesFilter(item, lowerFilter);
            this.parent.setItemVisibility(id, visible);
            if (visible) visibleItemsCount++;
        });

        optgroups.forEach(group => {
            const groupName = group.getAttribute('group-name');
            const groupItems = this.parent.getGroupItems(group);
            const visibleGroupItems = groupItems.filter(item => item.visible);
            
            if (visibleGroupItems.length > 0 || group.querySelector('span').textContent.toLowerCase().includes(lowerFilter)) {
                group.style.display = '';
                group.classList.remove('collapsed');
                const ul = group.nextElementSibling;
                if (ul && ul.tagName.toLowerCase() === 'ul') {
                    ul.style.display = '';
                }
            } else {
                group.style.display = 'none';
            }
        });

        if (visibleItemsCount === 0) {
            this.parent.ui.showEmptyStatus();
        } else {
            this.parent.ui.hideStatus();
        }

        if (this.parent.options.onSearch) {
            this.parent.options.onSearch(filter, this.parent.items.getSelectedItems());
        }

        // this.updateItemStates();
        // this.updateSelectAllButtonStates();
    }

    // ... (other search-related methods)
};

class UIModule {
    constructor(p) {
        if (!(p instanceof HpvCheckList)) {
            throw new HpvCheckListError('Parent must be an instance of HpvCheckList');
        }
        
        this.parent = p;
        this.createDropdownContainer();
        // select all button and group buttons ( by Event Target )
        this.setupSelectAllButtons();
        // create inclusion/exclusion mode toggle button
        this.setupExclusionModeToggle();
    }

    showEmptyStatus() {
        this.showCustomStatus(this.parent.options.emptyText);
    }

    showCustomStatus(htmlContent) {
        const statusContainer = this.parent.container.querySelector('.hpv-checklist-status-container');
        statusContainer.querySelector('span').innerHTML = htmlContent;
        statusContainer.style.display = 'flex';
    }

    hideStatus() {
        this.parent.container.querySelector('.hpv-checklist-status-container').style.display = 'none';
    }

    setupSelectAllButtons() {
        this.parent.container.addEventListener('click', (e) => {
            if (e.target.matches('.select-all-group')) {
                this.parent.selectAllGroup(e.target);
            } else if (e.target.matches('.select-all-main')) {
                this.parent.selectAllMain();
            }
        });
    }

    // create inclusion/exclusion mode toggle button
    setupExclusionModeToggle() {
        const { exclusionText, inclusionText } = this.parent.options;

        const toggleButton = document.createElement('button');
        toggleButton.className = 'exclusion-mode-toggle';
        toggleButton.innerHTML = this.parent.currentModeIsExclusion ? exclusionText : inclusionText;
        
        toggleButton.addEventListener('click', () => {
            this.parent.toogleCurrentMode();
            // toggle class .exclusion-active
            toggleButton.classList.toggle('exclusion-active');
            toggleButton.innerHTML = this.parent.currentModeIsExclusion ? exclusionText : inclusionText;
            // update item states based on mode
            this.parent.updateItemStates();
            
            // do callback
            if (this.parent.options.onExclusionModeChange) {
                this.parent.options.onExclusionModeChange(this.parent.currentModeIsExclusion, this.parent.items.getSelectedItems());
            }
        });
        
        // add new button
        this.parent.container.querySelector('.hpv-checklist-btn-group').appendChild(toggleButton);
    }

    createDropdownContainer() {
        // set class hpv-checklist to this.container
        this.parent.container.classList.add('hpv-checklist');
        const { searchPlaceholder, clearSearchTooltip, selectAllMainText, emptyText } = this.parent.options;

        const dropdownHTML = `
            <div class="search-container">
                <input type="text" class="search-input" placeholder="${searchPlaceholder}">
                <button class="clear-search" title="${clearSearchTooltip}">&times;</button>
            </div>
            <div class="hpv-checklist-content">
                <div class="hpv-checklist-btn-group">
                    <button class="select-all-main">${selectAllMainText}</button>
                </div>
                <div class="hpv-checklist-status-container">
                    <span>${emptyText}</span>    
                </div>
                <div class="hpv-checklist-checkbox-list"></div>
            </div>
        `;

        // Append the HTML to the desired parent element
        this.parent.container.innerHTML += dropdownHTML;
    }
};

var scope = {};
document.addEventListener('DOMContentLoaded', () => {
    const checklist1 = new HpvCheckList('checklist1', {
        searchPlaceholder: "Buscar por...",
        selectAllMainText: "Selec. Todos VisÃ­veis",
        selectAllGroupText: "Selec. Grupo",
        clearSearchTooltip: "Limpar a Busca",
        inclusionText: "Modo: <b>InclusÃ£o</b>",
        exclusionText: "Modo: <b>ExclusÃ£o</b>",
        emptyText: "Nenhum item disponÃ­vel",
        fuseThreshold: 0.3,
        selectMode: 'multiple', // 'single' or 'multiple'
        maxSelectableItemsInclusionMode: 1000,  // New option
        maxSelectableItemsExclusionMode: 1000,  // New option
        onSelect: (checkbox, previousSelected) => console.log('Selected:', checkbox, 'Previous:', previousSelected),
        onDeselect: (checkbox, previousSelected) => console.log('Deselected:', checkbox, 'Previous:', previousSelected),
        onSelectAll: (checkboxes, previousSelected) => console.log('Selected all:', checkboxes.map(cb => cb.id), 'Previous:', previousSelected),
        onDeselectAll: (checkboxes, previousSelected) => console.log('Deselected all:', checkboxes.map(cb => cb.id), 'Previous:', previousSelected),
        onSelectGroup: (group, checkboxes, previousSelected) => console.log('Selected group:', group.textContent, checkboxes.map(cb => cb.id), 'Previous:', previousSelected),
        onDeselectGroup: (group, checkboxes, previousSelected) => console.log('Deselected group:', group.textContent, checkboxes.map(cb => cb.id), 'Previous:', previousSelected),
        onCollapseGroup: (group) => console.log('Collapsed group:', group.textContent),
        onExpandGroup: (group) => console.log('Expanded group:', group.textContent),
        onSearch: (searchTerm) => console.log('Searched for:', searchTerm),
        onClearSearch: () => console.log('Search cleared'),
    });

    const items = [
        { id: 1, label: 'Apple', optgroup: 'Fruits', checked: true },
        { id: 2, label: 'Banana', optgroup: 'Fruits', disabled: true },
        { id: 3, label: 'Cherry', optgroup: 'Fruits' },
        { id: 10, label: 'Carrot', optgroup: 'Vegetables' },
        { id: 11, label: 'Broccoli', optgroup: 'Vegetables' },
        { id: 12, label: 'Spinach', optgroup: 'Vegetables' },
        { id: 20, label: 'Gol Gti 1.0', optgroup: 'Cars' },
        { id: 21, label: 'Fiat Palio V8', optgroup: 'Cars' },
        { id: 22, label: 'Camaro Bubblebee', optgroup: 'Cars' },
    ];

    checklist1.addItems(items);

    checklist1.addItem({ 'id': 4, 'label': 'Abacaxi', 'optgroup': 'Fruits' });
    // checklist1.removeAllItems();

    scope.checklist1 = checklist1;

    console.log('Dropdown 1 selected items:', checklist1.items.getSelectedItems());
    // console.log('Dropdown 2 selected items:', dropdown2.getSelectedItems());

    // Example usage:
    // checklist1.checkItem('1', scope.checklist1.MODE_INCLUSION, false);

    console.log('Dropdown 1 selected IDs:', checklist1.items.getSelectedIds());
    // console.log('Dropdown 2 selected IDs:', dropdown2.items.getSelectedIds());
});
   </script>
</body>
</html>